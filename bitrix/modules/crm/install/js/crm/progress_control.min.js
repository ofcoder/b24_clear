if(typeof BX.CrmDealStageManager==="undefined"){BX.CrmDealStageManager=function(){};BX.CrmDealStageManager.prototype={getInfos:function(e){if(!BX.type.isNotEmptyString(e)){e="category_0"}return BX.type.isArray(BX.CrmDealStageManager.infos[e])?BX.CrmDealStageManager.infos[e]:[]},isMultiType:function(){return true},getMessage:function(e){var t=BX.CrmDealStageManager.messages;return BX.type.isNotEmptyString(t[e])?t[e]:""},prepareDialogControls:function(e){return null}};BX.CrmDealStageManager.current=new BX.CrmDealStageManager;BX.CrmDealStageManager.infos={category_0:[{id:"NEW",name:"In Progress",sort:10,semantics:"process"},{id:"WON",name:"Is Won",sort:20,semantics:"success"},{id:"LOSE",name:"Is Lost",sort:30,semantics:"failure"}]};BX.CrmDealStageManager.messages={}}if(typeof BX.CrmDealRecurringStageManager==="undefined"){BX.CrmDealRecurringStageManager=function(){};BX.CrmDealRecurringStageManager.prototype={getInfos:function(e){return[]},isMultiType:function(){return false},getMessage:function(e){return""},prepareDialogControls:function(e){return null}};BX.CrmDealRecurringStageManager.current=new BX.CrmDealRecurringStageManager}if(typeof BX.CrmLeadStatusManager==="undefined"){BX.CrmLeadStatusManager=function(){this._admissionPromise=null;this._admissionResult=null};BX.CrmLeadStatusManager.prototype={getInfos:function(e){return BX.CrmLeadStatusManager.infos},isMultiType:function(){return false},getMessage:function(e){return BX.prop.getString(BX.CrmLeadStatusManager.messages,e,e)},admitChange:function(e,t){this._admissionPromise=new BX.Promise;this._admissionResult={succeeded:false,previousId:e,currentId:t};if(e===t||e!=="CONVERTED"){window.setTimeout(function(){this._admissionResult["succeeded"]=true;this._admissionPromise.fulfill(this._admissionResult)}.bind(this),0)}else{var i=BX.Crm.ConfirmationDialog.get("cancelLeadConversion");if(!i){i=BX.Crm.ConfirmationDialog.create("cancelLeadConversion",{title:this.getMessage("conversionCancellationTitle"),content:this.getMessage("conversionCancellationContent")})}i.open().then(function(e){if(this._admissionPromise&&this._admissionResult){this._admissionResult["succeeded"]=!BX.prop.getBoolean(e,"cancel",true);this._admissionPromise.fulfill(this._admissionResult)}}.bind(this))}return this._admissionPromise}};BX.CrmLeadStatusManager.current=new BX.CrmLeadStatusManager;BX.CrmLeadStatusManager.infos=[{id:"NEW",name:"Not Processed",sort:10,semantics:"process"},{id:"CONVERTED",name:"Converted",sort:20,semantics:"success"},{id:"JUNK",name:"Junk",sort:30,semantics:"failure"}];BX.CrmLeadStatusManager.messages={}}if(typeof BX.CrmLeadTerminationControl==="undefined"){BX.CrmLeadTerminationControl=function(){this._id="";this._settings=null;this._entityId="";this._enabled=true;this._schemeData=null;this._selector=null;this._permissionCheckCallback=null;this._showPermissionErrorCallback=null;this._dialogOpenListener=BX.delegate(this.onDialogOpen,this);this._dialogCloseListener=BX.delegate(this.onDialogClose,this)};BX.CrmLeadTerminationControl.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:BX.CrmParamBag.create(null);this._entityId=parseInt(this.getSetting("entityId",0));this._enabled=this.getSetting("canConvert",true);this._schemeData=this.getSetting("conversionScheme",{});this._permissionCheckCallback=this.getSetting("permissionCheckCallback",null);this._showPermissionErrorCallback=this.getSetting("showPermissionErrorCallback",null)},getSetting:function(e,t){return this._settings.getParam(e,t)},setSetting:function(e,t){this._settings.setParam(e,t)},getId:function(){return this._id},getEntityId:function(){return this._entityId},isEnabled:function(){return this._enabled},prepareControlId:function(e){return(this._id+"_"+e).toLowerCase()},prepareDialogControls:function(e){var t={};var i=false;var s=e.getSetting("success");if(s){i=true;const e=BX.create("SPAN",{attrs:{id:this.prepareControlId("success_btn_wrapper"),className:"webform-small-button-separate-wrap"},children:[BX.create("SPAN",{attrs:{id:this.prepareControlId("success_btn_inner_wrapper"),className:"webform-small-button webform-small-button-accept"},children:[BX.create("SPAN",{text:this._schemeData["schemeCaption"]+": "}),BX.create("SPAN",{attrs:{id:this.prepareControlId("success_btn")},text:this._schemeData["schemeDescription"]})]}),BX.create("SPAN",{attrs:{id:this.prepareControlId("success_btn_menu"),className:"webform-small-button-right-part"}})]});if(this.isPermissionsCheckAvailable()&&!this._permissionCheckCallback()){i=false;BX.Dom.addClass(e,"--disabled");e.onclick=()=>{this._showPermissionErrorCallback()}}t.successButton=e}if(i){e.addOpenListener(this._dialogOpenListener);e.addCloseListener(this._dialogCloseListener)}return t},isPermissionsCheckAvailable(){return BX.type.isFunction(this._permissionCheckCallback)&&BX.type.isFunction(this._showPermissionErrorCallback)},onDialogOpen:function(e){if(this._selector){this._selector.release();this._selector=null}this._selector=this._tryCreateSelectorViaConversionExtension();if(!this._selector){this._selector=BX.CrmLeadConversionSchemeSelector.create(this.prepareControlId("conv_scheme_selector"),{typeId:this.getSetting("typeId",BX.CrmLeadConversionType.general),entityId:this._entityId,scheme:this._schemeData["schemeName"],containerId:this.prepareControlId("success_btn_inner_wrapper"),labelId:this.prepareControlId("success_btn"),buttonId:this.prepareControlId("success_btn_menu"),originUrl:this._schemeData["originUrl"],enableHint:false})}},_tryCreateSelectorViaConversionExtension:function(){if(!BX.Reflection.getClass("BX.Crm.Conversion.Manager")||!BX.Reflection.getClass("BX.Crm.Conversion.SchemeSelector")||!BX.Reflection.getClass("BX.Crm.Integration.Analytics.Dictionary")){return null}const e=this.getSetting("converterId",null);if(!e){return null}const t=BX.Crm.Conversion.Manager.Instance.getConverter(e);if(!t){console.error(`converter with id ${e} not found`);return null}const i=new BX.Crm.Conversion.SchemeSelector(t,{entityId:this._entityId,containerId:this.prepareControlId("success_btn_inner_wrapper"),labelId:this.prepareControlId("success_btn"),buttonId:this.prepareControlId("success_btn_menu"),analytics:{c_element:BX.Crm.Integration.Analytics.Dictionary.ELEMENT_TERMINATION_CONTROL}});i.enableAutoConversion();return i},onDialogClose:function(e){if(this._selector){this._selector.release();this._selector=null}e.removeOpenListener(this._dialogOpenListener);e.removeCloseListener(this._dialogCloseListener)}};BX.CrmLeadTerminationControl.create=function(e,t){var i=new BX.CrmLeadTerminationControl;i.initialize(e,t);return i}}if(typeof BX.CrmQuoteStatusManager==="undefined"){BX.CrmQuoteStatusManager=function(){};BX.CrmQuoteStatusManager.prototype={getInfos:function(e){return BX.CrmQuoteStatusManager.infos},isMultiType:function(){return false},getMessage:function(e){var t=BX.CrmQuoteStatusManager.messages;return BX.type.isNotEmptyString(t[e])?t[e]:""},prepareDialogControls:function(e){return null}};BX.CrmQuoteStatusManager.current=new BX.CrmQuoteStatusManager;BX.CrmQuoteStatusManager.infos=[{id:"DRAFT",name:"In Progress",sort:10,semantics:"process"},{id:"APPROVED",name:"Is Approved",sort:20,semantics:"success"},{id:"DECLAINED",name:"Is Declained",sort:30,semantics:"failure"}];BX.CrmQuoteStatusManager.messages={}}if(typeof BX.CrmOrderShipmentStatusManager==="undefined"){BX.CrmOrderShipmentStatusManager=function(){};BX.CrmOrderShipmentStatusManager.prototype={getInfos:function(e){return BX.CrmOrderShipmentStatusManager.infos},isMultiType:function(){return false},getMessage:function(e){var t=BX.CrmOrderShipmentStatusManager.messages;return BX.type.isNotEmptyString(t[e])?t[e]:""},prepareDialogControls:function(e){return null}};BX.CrmOrderShipmentStatusManager.current=new BX.CrmOrderShipmentStatusManager;BX.CrmOrderShipmentStatusManager.infos=[{id:"DN",name:"In Progress",sort:10,semantics:"process"},{id:"DF",name:"Deducted",sort:20,semantics:"success"}];BX.CrmOrderShipmentStatusManager.messages={}}if(typeof BX.CrmOrderStatusManager==="undefined"){BX.CrmOrderStatusManager=function(){this.dlg=null};BX.CrmOrderStatusManager.prototype={getSetting:function(e,t){return typeof BX.CrmOrderStatusManager.settings[e]!=="undefined"?BX.CrmOrderStatusManager.settings[e]:t},isMultiType:function(){return false},setSetting:function(e,t){BX.CrmOrderStatusManager.settings[e]=t},getInfos:function(e){return BX.CrmOrderStatusManager.infos},getMessage:function(e){var t=BX.CrmOrderStatusManager.messages;return BX.type.isNotEmptyString(t[e])?t[e]:""},prepareDialogControls:function(e){return null}};BX.CrmOrderStatusManager.current=new BX.CrmOrderStatusManager;BX.CrmOrderStatusManager.settings={};BX.CrmOrderStatusManager.statusInfoValues=[];BX.CrmOrderStatusManager.infos=[{id:"N",name:"In Progress",sort:10,semantics:"process"},{id:"F",name:"Is Paid",sort:20,semantics:"success"},{id:"D",name:"Is Dismiss",sort:30,semantics:"failure"}];BX.CrmOrderStatusManager.messages={};BX.CrmOrderStatusManager.failureDialogEventsBinded=false;BX.CrmOrderStatusManager.failureDialogEventsBind=function(){if(!BX.CrmOrderStatusManager.failureDialogEventsBinded){BX.CrmOrderStatusManager.failureDialogEventsBinded=true;BX.addCustomEvent("CrmProcessFailureDialogContentCreated",(function(e){var t=BX.CrmOrderStatusManager.current;var i=e.getEntityType();if(i==="ORDER"){var s=parseInt(e.getEntityId());var n=e.getWrapper();var r="crm_"+i+s+"_params";var a=r+"_failure";t.failureParamsId=a;if(n&&s>0&&i.length>0){var o=BX.CrmOrderStatusManager.statusInfoValues[s],l=BX.create("DIV",{attrs:{id:r},children:[BX.create("DIV",{attrs:{id:a,class:"crm-invoice-term-dialog-params"},children:[BX.create("SPAN",{attrs:{class:"comment-header"},text:t.getMessage("commentLabelText")+":"}),BX.create("TEXTAREA",{attrs:{class:"bx-crm-dialog-invoice-textarea",name:"REASON_CANCELED"},text:o["REASON_CANCELED"]?o["REASON_CANCELED"]:""})]})]});if(l)n.appendChild(l)}}}));BX.addCustomEvent("CrmProgressControlBeforeFailureDialogClose",(function(e,t){var i=t.getEntityType();if(i==="ORDER"){var s=BX.CrmOrderStatusManager.current;var n=BX(s.failureParamsId);s.saveParams={};if(n){var r=[];var a=BX.findChildren(n,{tag:"input"},true);if(a)r=r.concat(a);var o=BX.findChildren(n,{tag:"textarea"},true);if(o)r=r.concat(o);var l;for(var u in r){l=r[u].getAttribute("name");if(l)s.saveParams[l]=r[u].value}}}}));BX.addCustomEvent("CrmProgressControlBeforeSave",(function(e,t){if(e.getEntityType()!=="ORDER")return;var i=BX.CrmOrderStatusManager.current;if(BX.type.isPlainObject(i.saveParams)){var s=e.getEntityId();for(var n in i.saveParams){if(s>0)BX.CrmOrderStatusManager.statusInfoValues[s][n]=i.saveParams[n];t[n]=i.saveParams[n]}}t["STATE_SUCCESS"]=i.isSuccess?"Y":"N"}));BX.addCustomEvent("CrmProgressControlAfterSaveSucces",(function(e,t){if(e.getEntityType()!=="ORDER")return;if(BX.type.isNotEmptyString(t["ERROR"])&&BX.type.isNotEmptyString(t["STATUS_ID"])){e._currentStepId=t["STATUS_ID"];e._layout()}}))}}}if(typeof BX.CrmInvoiceStatusManager==="undefined"){BX.CrmInvoiceStatusManager=function(){this.dlg=null};BX.CrmInvoiceStatusManager.prototype={getSetting:function(e,t){return typeof BX.CrmInvoiceStatusManager.settings[e]!=="undefined"?BX.CrmInvoiceStatusManager.settings[e]:t},setSetting:function(e,t){BX.CrmInvoiceStatusManager.settings[e]=t},getInfos:function(e){return BX.CrmInvoiceStatusManager.infos},getMessage:function(e){var t=BX.CrmInvoiceStatusManager.messages;return BX.type.isNotEmptyString(t[e])?t[e]:""},prepareDialogControls:function(e){return null},_handleDateInputClick:function(e){var t=BX(this.dlgDateControlId);BX.calendar({node:BX(t),field:t,bTime:false,serverTime:this.getSetting("serverTime",""),bHideTimebar:true})},_handleDateImageMouseOver:function(e){BX.addClass(e.target,"calendar-icon-hover")},_handleDateImageMouseOut:function(e){if(!e){e=window.event}BX.removeClass(e.target,"calendar-icon-hover")}};BX.CrmInvoiceStatusManager.current=new BX.CrmInvoiceStatusManager;BX.CrmInvoiceStatusManager.settings={};BX.CrmInvoiceStatusManager.statusInfoValues=[];BX.CrmInvoiceStatusManager.infos=[{id:"N",name:"In Progress",sort:10,semantics:"process"},{id:"F",name:"Is Paid",sort:20,semantics:"success",hasParams:true},{id:"D",name:"Is Dismiss",sort:30,semantics:"failure"}];BX.CrmInvoiceStatusManager.messages={};BX.CrmInvoiceStatusManager.failureDialogEventsBinded=false;BX.CrmInvoiceStatusManager.failureDialogEventsBind=function(){if(!BX.CrmInvoiceStatusManager.failureDialogEventsBinded){BX.CrmInvoiceStatusManager.failureDialogEventsBinded=true;BX.addCustomEvent("CrmProcessFailureDialogContentCreated",(function(e){var t=BX.CrmInvoiceStatusManager.current;var i=e.getEntityType();if(i==="INVOICE"){var s=parseInt(e.getEntityId());var n=e.getWrapper();var r=e.getValue()===e.getSuccessValue();var a="crm_"+i+s+"_params";var o=a+"_success";var l=a+"_failure";var u="crm_"+i+s+"_date_success";var c="crm_"+i+s+"_date_fail";t.isSuccess=r;t.successParamsId=o;t.failureParamsId=l;t.dlgDateControlId=r?u:c;if(n&&s>0&&i.length>0){var h=BX.CrmInvoiceStatusManager.statusInfoValues[s];var d=null;d=BX.create("DIV",{attrs:{id:a},children:[BX.create("DIV",{attrs:{id:o,class:"crm-invoice-term-dialog-params",style:r?"":"display: none;"},children:[BX.create("TABLE",{children:[BX.create("TR",{children:[BX.create("TD",{class:"left-column",text:t.getMessage("dateLabelText")+":"}),BX.create("TD",{children:[BX.create("INPUT",{attrs:{className:"bx-crm-dialog-input"},props:{type:"text",id:u,name:"PAY_VOUCHER_DATE",value:h["PAY_VOUCHER_DATE"]?h["PAY_VOUCHER_DATE"]:BX.formatDate(null,BX.message("FORMAT_DATE"))},style:{width:"70px"},events:{click:BX.delegate(t._handleDateInputClick,t)}}),BX.create("A",{props:{href:"javascript:void(0);",title:t.getMessage("setDate")},children:[BX.create("IMG",{attrs:{src:t.getSetting("imagePath","")+"calendar.gif",className:"calendar-icon",alt:t.getMessage("setDate")},events:{click:BX.delegate(t._handleDateInputClick,t),mouseover:BX.delegate(t._handleDateImageMouseOver,t),mouseout:BX.delegate(t._handleDateImageMouseOut,t)}})]})]})]}),BX.create("TR",{children:[BX.create("TD",{class:"left-column",text:t.getMessage("payVoucherNumLabelText")+":"}),BX.create("TD",{children:[BX.create("INPUT",{attrs:{class:"bx-crm-dialog-input",type:"text",name:"PAY_VOUCHER_NUM",value:h["PAY_VOUCHER_NUM"]?h["PAY_VOUCHER_NUM"].substring(0,20):"",maxlength:20,size:20}})]})]})]}),BX.create("DIV",{attrs:{class:"separator"}}),BX.create("SPAN",{attrs:{class:"comment-header"},text:t.getMessage("commentLabelText")+":"}),BX.create("TEXTAREA",{attrs:{class:"bx-crm-dialog-invoice-textarea",name:"REASON_MARKED_SUCCESS"},text:h["REASON_MARKED"]?h["REASON_MARKED"]:""})]}),BX.create("DIV",{attrs:{id:l,class:"crm-invoice-term-dialog-params",style:r?"display: none;":""},children:[BX.create("TABLE",{children:[BX.create("TR",{children:[BX.create("TD",{class:"left-column",text:t.getMessage("dateLabelText")+":"}),BX.create("TD",{children:[BX.create("INPUT",{attrs:{className:"bx-crm-dialog-input"},props:{type:"text",id:c,name:"DATE_MARKED",value:h["DATE_MARKED"]?h["DATE_MARKED"]:BX.formatDate(null,BX.message("FORMAT_DATE"))},style:{width:"70px"},events:{click:BX.delegate(t._handleDateInputClick,t)}}),BX.create("A",{props:{href:"javascript:void(0);",title:t.getMessage("setDate")},children:[BX.create("IMG",{attrs:{src:t.getSetting("imagePath","")+"calendar.gif",className:"calendar-icon",alt:t.getMessage("setDate")},events:{click:BX.delegate(t._handleDateInputClick,t),mouseover:BX.delegate(t._handleDateImageMouseOver,t),mouseout:BX.delegate(t._handleDateImageMouseOut,t)}})]})]})]})]}),BX.create("DIV",{attrs:{class:"separator"}}),BX.create("SPAN",{attrs:{class:"comment-header"},text:t.getMessage("commentLabelText")+":"}),BX.create("TEXTAREA",{attrs:{class:"bx-crm-dialog-invoice-textarea",name:"REASON_MARKED"},text:h["REASON_MARKED"]?h["REASON_MARKED"]:""})]})]});if(d)n.appendChild(d)}}}));BX.addCustomEvent("CrmProcessFailureDialogValueChanged",(function(e,t){var i=BX.CrmInvoiceStatusManager.current;var s=e.getEntityType();if(s==="INVOICE"){var n=parseInt(e.getEntityId());var r=e.getWrapper();var a=t===e.getSuccessValue();var o="crm_"+s+n+"_params";var l=o+"_success";var u=o+"_failure";var c=BX(l);var h=BX(u);var d="crm_"+s+n+"_date_success";var p="crm_"+s+n+"_date_fail";i.isSuccess=a;i.dlgDateControlId=a?d:p;if(c)c.setAttribute("style",a?"":"display: none;");if(h)h.setAttribute("style",a?"display: none;":"")}}));BX.addCustomEvent("CrmProgressControlBeforeFailureDialogClose",(function(e,t){var i=t.getEntityType();if(i==="INVOICE"){var s=BX.CrmInvoiceStatusManager.current;var n=BX(s.isSuccess?s.successParamsId:s.failureParamsId);s.saveParams={};if(n){var r=[];var a=BX.findChildren(n,{tag:"input"},true);if(a)r=r.concat(a);var o=BX.findChildren(n,{tag:"textarea"},true);if(o)r=r.concat(o);var l;for(var u in r){l=r[u].getAttribute("name");if(l)s.saveParams[l]=r[u].value}}}}));BX.addCustomEvent("CrmProgressControlBeforeSave",(function(e,t){if(e.getEntityType()!=="INVOICE"){return}var i=BX.CrmInvoiceStatusManager.current;if(BX.type.isPlainObject(i.saveParams)){var s=e.getEntityId();var n;for(var r in i.saveParams){if(s>0){if(r==="REASON_MARKED_SUCCESS")n="REASON_MARKED";else n=r;BX.CrmInvoiceStatusManager.statusInfoValues[s][n]=i.saveParams[r]}t[r]=i.saveParams[r]}}t["STATE_SUCCESS"]=i.isSuccess?"Y":"N"}))}}}if(typeof BX.CrmItemStatusManager==="undefined"){BX.CrmItemStatusManager=function(){};BX.CrmItemStatusManager.prototype={getInfos:function(e){if(BX.CrmItemStatusManager.infos===[]){console.log("Error: CrmItemStatusManager has not default stages")}return BX.type.isArray(BX.CrmItemStatusManager.infos[e])?BX.CrmItemStatusManager.infos[e]:[]},isMultiType:function(){return false},getMessage:function(e){var t=BX.CrmItemStatusManager.messages;return BX.type.isNotEmptyString(t[e])?t[e]:""},prepareDialogControls:function(e){return null}};BX.CrmItemStatusManager.current=new BX.CrmItemStatusManager;BX.CrmItemStatusManager.messages={};BX.CrmItemStatusManager.infos=[]}if(typeof BX.CrmProgressManager==="undefined"){BX.CrmProgressManager=function(){};BX.CrmProgressManager.prototype={resolve:function(e){if(e===BX.CrmEntityType.enumeration.deal){return BX.CrmDealStageManager.current}else if(e===BX.CrmEntityType.enumeration.dealrecurring){return BX.CrmDealRecurringStageManager.current}else if(e===BX.CrmEntityType.enumeration.quote){return BX.CrmQuoteStatusManager.current}else if(e===BX.CrmEntityType.enumeration.lead){return BX.CrmLeadStatusManager.current}else if(e===BX.CrmEntityType.enumeration.order){return BX.CrmOrderStatusManager.current}else if(e===BX.CrmEntityType.enumeration.ordershipment){return BX.CrmOrderShipmentStatusManager.current}return null},isMultiType:function(e){var t=this.resolve(e);if(!t){return false}return BX.type.isFunction(t.isMultiType)&&t.isMultiType()}};BX.CrmProgressManager.current=new BX.CrmProgressManager}if(typeof BX.CrmProgressControl==="undefined"){BX.CrmProgressControl=function(){this._id="";this._settings=null;this._container=null;this._legendContainer=null;this._entityId=0;this._entityType=null;this._previousStepId="";this._currentStepId="";this._infoTypeId="";this._manager=null;this._stepInfos=null;this._steps=[];this._terminationControl=null;this._terminationDlg=null;this._failureDlg=null;this._isFrozen=false;this._isReadOnly=false;this.permissionChecker=null;this._entityEditorDialog=null;this._externalEventHandler=null;this._entityConvertHandler=null;this._entityEditorDialogHandler=BX.delegate(this._onEntityEditorDialogClose,this);this._enableFillContainerBackground=false;this._enableCustomColors=false;this._defaultProcessColor="#ACE9FB";this._defaultSuccessSuccessColor="#DBF199";this._defaultFailureColor="#FFBEBD"};BX.CrmProgressControl.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:BX.CrmParamBag.create(null);this._container=BX(this.getSetting("containerId"));var i=this.getSetting("legendContainerId");if(BX.type.isNotEmptyString(i)){this._legendContainer=BX(i)}if(!BX.type.isElementNode(this._legendContainer)){this._legendContainer=BX.findNextSibling(this._container,{className:"crm-list-stage-bar-title"})}this._entityId=parseInt(this.getSetting("entityId",0));this._entityType=this.getSetting("entityType");this._currentStepId=this.getSetting("currentStepId");this._infoTypeId=this.getSetting("infoTypeId","");this._enableCustomColors=this.getSetting("enableCustomColors");if(this._entityType==="DEAL"){this._manager=BX.CrmDealStageManager.current}else if(this._entityType==="LEAD"){this._manager=BX.CrmLeadStatusManager.current;this._terminationControl=BX.CrmLeadTerminationControl.create(this._id,BX.CrmParamBag.create({entityId:this._entityId,conversionScheme:this.getSetting("conversionScheme",null),canConvert:this.getSetting("canConvert",true),typeId:this.getSetting("conversionTypeId",BX.CrmLeadConversionType.general),converterId:this.getSetting("converterId",null),permissionCheckCallback:this.isHasPermissionToMoveSuccessStage.bind(this),showPermissionErrorCallback:this.showMissPermissionError.bind(this)}))}else if(this._entityType==="QUOTE"){this._manager=BX.CrmQuoteStatusManager.current}else if(this._entityType==="ORDER"){this._manager=BX.CrmOrderStatusManager.current}else if(this._entityType==="ORDER_SHIPMENT"){this._manager=BX.CrmOrderShipmentStatusManager.current}else if(this._entityType==="INVOICE"){this._manager=BX.CrmInvoiceStatusManager.current}else if(BX.CrmEntityType.isUseDynamicTypeBasedApproachByName(this._entityType)){this._manager=BX.CrmItemStatusManager.current}var s=this._stepInfos=this._manager.getInfos(this._infoTypeId);var n=this._findStepInfoIndex(this._currentStepId);var r=n>=0?s[n]:null;this._isReadOnly=this.getSetting("readOnly",false);this._isFrozen=this._isReadOnly||(r&&BX.type.isBoolean(r["isFrozen"])?r["isFrozen"]:false);for(var a=0;a<s.length;a++){var o=s[a];var l=this.getStepContainer(o["id"]);if(!l){continue}var u=parseInt(o["sort"]);this._steps.push(BX.CrmProgressStep.create(o["id"],BX.CrmParamBag.create({name:o["name"],hint:BX.type.isNotEmptyString(o["hint"])?o["hint"]:"",sort:u,isPassed:a<=n,isReadOnly:this._isReadOnly,control:this,semantics:o.semantics})))}this.adjustDisableOfSteps()},getSetting:function(e,t){return this._settings.getParam(e,t)},setSetting:function(e,t){this._settings.setParam(e,t)},getId:function(){return this._id},getEntityType:function(){return this._entityType},getEntityId:function(){return this._entityId},getCurrentStepId:function(){return this._currentStepId},getStepById:function(e){for(var t=0,i=this._steps.length;t<i;t++){var s=this._steps[t];if(s.getId()===e){return s}}return null},getPermissionChecker(){if(this.permissionChecker===null){const e=this._stepInfos??this._manager.getInfos(this._infoTypeId);this.permissionChecker=BX.Crm.Stage.PermissionChecker.createFromStageInfos(e)}return this.permissionChecker},isHasPermissionToMove(e){return this.getPermissionChecker().isHasPermissionToMove(this.getCurrentStepId(),e)},isHasPermissionToMoveFailureStages(){return this.getPermissionChecker().isHasPermissionToMoveAtLeastOneFailureStage(this.getCurrentStepId())},isHasPermissionToMoveTerminationStages(){return this.getPermissionChecker().isHasPermissionToMoveAtLeastOneTerminationStage(this.getCurrentStepId())},isHasPermissionToMoveSuccessStage(){return this.getPermissionChecker().isHasPermissionToMoveSuccessStage(this.getCurrentStepId())},showMissPermissionError(){this.getPermissionChecker().showMissPermissionError()},isFrozen:function(){return this._isFrozen},isReadOnly:function(){return this._isReadOnly},isDisableStep(e){if(["success","failure"].includes(e.getSemantics())){return!this.isHasPermissionToMoveTerminationStages()}return!this.isHasPermissionToMove(e.getId())},onExternalEvent:function(e){var t=BX.prop.getString(e,"key","");if(t!=="onCrmEntityConvert"){return}var i=BX.prop.getObject(e,"value",{});if(this._entityType===BX.prop.getString(i,"entityTypeName")&&this._entityId===BX.prop.getInteger(i,"entityId",0)){this._closeTerminationDialog();this._closeFailureDialog()}},onEntityConvert:function(e,t){if(this._entityType===BX.prop.getString(t,"entityTypeName")&&this._entityId===BX.prop.getInteger(t,"entityId",0)){this._closeTerminationDialog();this._closeFailureDialog()}},getStepContainer:function(e){return BX.type.isNotEmptyString(e)?BX.findChild(this._container,{tag:"DIV",class:"crm-stage-"+e.toLowerCase()},true):null},setCurrentStep:function(e){this._closeTerminationDialog();if(!e||this._isReadOnly||this._isFrozen||this._entityEditorDialog!==null){return}if(BX.type.isFunction(this._manager["admitChange"])){this._manager.admitChange(this._currentStepId,e.getId()).then(function(e){if(!BX.prop.getBoolean(e,"succeeded",false)){return}var t=this.getStepById(BX.prop.getString(e,"currentId",""));if(t){this.setupStep(t)}}.bind(this))}else{this.setupStep(e)}},setupStep(e){const t=this._findStepInfoIndex(e.getId());if(t<0){return}if(t===this._steps.length-1&&this._findStepInfoBySemantics("success")&&this._findStepInfoBySemantics("failure")){if(!this._terminationControl||this._terminationControl.isEnabled()){if(!this.isHasPermissionToMoveTerminationStages()){this.showMissPermissionError();return}this._openTerminationDialog()}return}const i=e.getId();if(this._currentStepId===i){return}if(!this.isHasPermissionToMove(i)){this.showMissPermissionError();return}this._previousStepId=this._currentStepId;this._currentStepId=i;this._layout();this._save()},setCurrentStepId(e){if(this._currentStepId!==e){this._previousStepId=this._currentStepId;this._currentStepId=e;this._layout()}},adjustDisableOfSteps(){this._steps.forEach((e=>{this.isDisableStep(e)?e.setDisable():e.removeDisable()}))},getCurrentStepInfo:function(){var e=this._findStepInfoIndex(this._currentStepId);return e>=0?this._stepInfos[e]:null},isCustomColorsEnabled:function(){return this._enableCustomColors},setColor:function(e){if(!this._stepInfos[e]||!this._enableCustomColors){return}const t=this._container.querySelectorAll("td.crm-list-stage-bar-part");for(var i=0;i<t.length;i++){if(i>e){t[i].style.background=""}else{var s=this._stepInfos[e];var n=BX.type.isNotEmptyString(s["color"])?s["color"]:"";if(n===""){var r=BX.type.isNotEmptyString(s["semantics"])?s["semantics"]:"";if(r==="success"){n=this._defaultSuccessSuccessColor}else if(r==="failure"){n=this._defaultFailureColor}else{n=this._defaultProcessColor}}t[i].style.background=n}}},_layout:function(){var e=this._findStepInfoIndex(this._currentStepId);if(e<0){return}for(var t=0;t<this._steps.length;t++){this._steps[t].setPassed(t<=e)}this.setColor(e);var i=this._stepInfos[e];this._isFrozen=BX.type.isBoolean(i["isFrozen"])?i["isFrozen"]:false;var s=BX.type.isNotEmptyString(i["semantics"])?i["semantics"]:"";if(this._enableFillContainerBackground){this.prepareContainerBackground(s)}if(this._legendContainer){this._legendContainer.innerHTML=BX.util.htmlspecialchars(BX.type.isNotEmptyString(i["name"])?i["name"]:i["id"])}this.adjustDisableOfSteps()},prepareContainerBackground(e){if(e==="success"){if(this._enableCustomColors){this._container.style.background=stepInfo["color"]}else{BX.addClass(this._container,"crm-list-stage-end-good");BX.removeClass(this._container,"crm-list-stage-end-bad")}}else if(e==="failure"||e==="apology"){if(this._enableCustomColors){this._container.style.background=stepInfo["color"]}else{BX.removeClass(this._container,"crm-list-stage-end-good");BX.addClass(this._container,"crm-list-stage-end-bad")}}else{if(this._enableCustomColors){this._container.style.background=""}else{BX.removeClass(this._container,"crm-list-stage-end-good");BX.removeClass(this._container,"crm-list-stage-end-bad")}}},_openTerminationDialog(){this._enableStepHints(false);if(this._terminationDlg){this._terminationDlg.close();this._terminationDlg=null}const e=`${this._id}_TERMINATION`;const t=this._findAllStepInfoBySemantics("apology");this._terminationDlg=BX.CrmProcessTerminationDialog.create(e,BX.CrmParamBag.create({title:this._manager.getMessage("dialogTitle"),failureTitle:t.length>0?this._manager.getMessage("failureTitle"):"",anchor:this._container,success:this._findStepInfoBySemantics("success"),failure:this._findStepInfoBySemantics("failure"),apologies:t,callback:this._onTerminationDialogClose.bind(this),terminationControl:this._terminationControl,buttonPrepareCallback:this.terminationButtonPrepareCallback.bind(this)}));this._terminationDlg.open();if(!this._externalEventHandler){this._externalEventHandler=this.onExternalEvent.bind(this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}if(!this._entityConvertHandler){this._entityConvertHandler=this.onEntityConvert.bind(this);BX.addCustomEvent(window,"Crm.EntityConverter.Converted",this._entityConvertHandler)}},_closeTerminationDialog:function(){if(!this._terminationDlg){return}this._terminationDlg.close(false);this._terminationDlg=null;this._enableStepHints(true);if(this._externalEventHandler){BX.removeCustomEvent(window,"onLocalStorageSet",this._externalEventHandler);this._externalEventHandler=null}},_onTerminationDialogClose(dialog,params){if(this._terminationDlg!==dialog){return}this._closeTerminationDialog();let stepId=BX.type.isNotEmptyString(params.result)?params.result:"";const index=this._findStepInfoIndex(stepId);if(index<0){return}let openFailureDialog=false;const info=this._stepInfos[index];const failure=this._findStepInfoBySemantics("failure");if(failure&&failure.id===stepId){openFailureDialog=true;if(!this.isHasPermissionToMoveFailureStages()){this.showMissPermissionError();return}if(!this.isHasPermissionToMove(stepId)){const e=this._findAllStepInfoBySemantics("apology").find((e=>this.isHasPermissionToMove(e.id)));stepId=e.id}}else if(info.semantics==="success"){if(!this.isHasPermissionToMove(stepId)){this.showMissPermissionError();return}if(typeof info.hasParams!=="undefined"&&info.hasParams===true){openFailureDialog=true}else{const finalScript=this.getSetting("finalScript","");if(finalScript!==""){eval(finalScript);return}const finalUrl=this.getSetting("finalUrl","");if(finalUrl!==""){window.location=finalUrl;return}}}this._previousStepId=this._currentStepId;this._currentStepId=stepId;if(openFailureDialog){this._openFailureDialog();return}this._layout();this._save()},terminationButtonPrepareCallback(e,t){if(this.isHasPermissionToMove(t.id)){return}if(t.semantics==="failure"&&this.isHasPermissionToMoveFailureStages()){return}BX.Dom.addClass(e,"--disabled")},_openFailureDialog:function(){this._enableStepHints(false);if(this._failureDlg){this._failureDlg.close();this._failureDlg=null}const e=this._findStepInfoIndex(this._currentStepId);const t=e>=0?this._stepInfos[e]:null;const i=t?t.id:"";const s=this._findAllStepInfoBySemantics("apology");const n=`${this._id}_FAILURE`;this._failureDlg=BX.CrmProcessFailureDialog.create(n,BX.CrmParamBag.create({entityType:this._entityType,entityId:this._entityId,initValue:i,failureTitle:s.length>0?this._manager.getMessage("failureTitle"):"",selectorTitle:this._manager.getMessage("selectorTitle"),anchor:this._container,success:this._findStepInfoBySemantics("success"),failure:this._findStepInfoBySemantics("failure"),apologies:s,callback:this._onFailureDialogClose.bind(this)}));BX.addCustomEvent("CrmProcessFailureDialogContentCreated",this.onCrmProcessFailureDialogContentCreated.bind(this));this._failureDlg.open();if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}},_closeFailureDialog:function(){if(!this._failureDlg){return}this._failureDlg.close(false);this._failureDlg=null;this._enableStepHints(true);if(this._externalEventHandler){BX.removeCustomEvent(window,"onLocalStorageSet",this._externalEventHandler);this._externalEventHandler=null}},_onFailureDialogClose(dialog,params){if(this._failureDlg!==dialog){return}BX.onCustomEvent(this,"CrmProgressControlBeforeFailureDialogClose",[this,this._failureDlg]);this._closeFailureDialog();const bid=BX.type.isNotEmptyString(params.bid)?params.bid:"";if(bid!=="accept"){this._currentStepId=this._previousStepId;return}const id=BX.type.isNotEmptyString(params.result)?params.result:"";const index=this._findStepInfoIndex(id);if(index<0){return}if(!this.getPermissionChecker().isHasPermissionToMove(this._previousStepId,id)){this.showMissPermissionError();this._currentStepId=this._previousStepId;return}const info=this._stepInfos[index];if(info.semantics==="success"){const finalScript=this.getSetting("finalScript","");if(finalScript!==""){eval(finalScript);return}const finalUrl=this.getSetting("finalUrl","");if(finalUrl!==""){window.location=finalUrl;return}const verboseMode=Boolean(this.getSetting("verboseMode",false));if(verboseMode){this._openTerminationDialog();return}}this._currentStepId=info.id;this._layout();this._save()},onCrmProcessFailureDialogContentCreated(e,t){if(this._failureDlg!==e){return}const i=this._previousStepId??this.getCurrentStepId();const s=t.querySelectorAll(".crm-list-end-deal-button-wrapper");s.forEach((e=>{const t=e.querySelector("input");if(!t){return}const s=t.value;if(this.getPermissionChecker().isHasPermissionToMove(i,s)){return}BX.Dom.addClass(e,"--disabled");t.onclick=e=>{this.showMissPermissionError();e.preventDefault()}}))},_save(){var e=this.getSetting("serviceUrl");var t=this.getCurrentStepId();var i=this.getEntityType();var s=this.getEntityId();if(e===""||t===""||i===""||s<=0){return}if(BX.CrmEntityType.isUseDynamicTypeBasedApproachByName(i)){BX.ajax.runAction(e,{data:{entityTypeId:BX.CrmEntityType.resolveId(i),id:s,fields:{stageId:this.getCurrentStepId()}}}).then(function(e){this._onSaveRequestSuccess(e.data)}.bind(this)).catch(function(e){var t=false;var i={};var s="";for(var n in e.errors){if(e.errors[n].code==="CRM_FIELD_ERROR_REQUIRED"){i[e.errors[n].customData.fieldName]=e.errors[n].message;t=true}if(s===""){s=e.errors[n].message}else{s=s+", "+e.errors[n].message}}var r={CHECK_ERRORS:i,ERROR:s,ID:this.getEntityId(),TYPE:this.getEntityType(),VALUE:this.getCurrentStepId()};if(t){this._onSaveRequestSuccess(r)}else{console.log(s);this._onSaveRequestFailure(r)}}.bind(this))}else{var n={ACTION:"SAVE_PROGRESS",VALUE:t,TYPE:i,ID:s,sessid:BX.bitrix_sessid()};BX.onCustomEvent(this,"CrmProgressControlBeforeSave",[this,n]);BX.ajax({url:e,method:"POST",dataType:"json",data:n,onsuccess:BX.delegate(this._onSaveRequestSuccess,this),onfailure:BX.delegate(this._onSaveRequestFailure,this)})}},_onSaveRequestSuccess:function(e){var t=BX.prop.getObject(e,"CHECK_ERRORS",null);if(t){this._openEntityEditorDialog({title:this._manager.getMessage("checkErrorTitle"),helpData:{text:this._manager.getMessage("checkErrorHelp"),code:this._manager.getMessage("checkErrorHelpArticleCode")},fieldNames:Object.keys(t),initData:BX.prop.getObject(e,"EDITOR_INIT_DATA",null),context:BX.prop.getObject(e,"CONTEXT",null),isController:BX.CrmEntityType.isUseFactoryBasedApproachByName(this.getEntityType()),stageId:BX.prop.getString(e,"VALUE",null)});return}BX.onCustomEvent(this,"CrmProgressControlAfterSaveSucces",[this,e]);BX.CrmProgressControl._synchronize(this)},_onSaveRequestFailure:function(e){BX.onCustomEvent(self,"CrmProgressControlAfterSaveFailed",[this,e])},_openEntityEditorDialog:function(e){BX.Crm.PartialEditorDialog.close("progressbar-entity-editor");this._entityEditorDialog=BX.Crm.PartialEditorDialog.create("progressbar-entity-editor",{title:BX.prop.getString(e,"title","Please fill in all required fields"),entityTypeName:this._entityType,entityId:this._entityId,fieldNames:BX.prop.getArray(e,"fieldNames",[]),helpData:BX.prop.getObject(e,"helpData",null),context:BX.prop.getObject(e,"context",null),isController:BX.prop.getBoolean(e,"isController",false),stageId:BX.prop.getString(e,"stageId",null)});window.setTimeout(function(){this._entityEditorDialog.open();BX.addCustomEvent(window,"Crm.PartialEditorDialog.Close",this._entityEditorDialogHandler)}.bind(this),150)},_onEntityEditorDialogClose:function(e,t){if(!(this._entityType===BX.prop.getString(t,"entityTypeName",0)&&this._entityId===BX.prop.getInteger(t,"entityId",0))){return}this._entityEditorDialog=null;BX.removeCustomEvent(window,"Crm.PartialEditorDialog.Close",this._entityEditorDialogHandler);if(BX.prop.getBoolean(t,"isCancelled",true)&&this._previousStepId!==""){var i=this._findStepInfoIndex(this._previousStepId);if(i>=0){this._currentStepId=this._previousStepId;this._previousStepId="";this._layout()}}},_findStepInfoBySemantics:function(e){var t=this._stepInfos;for(var i=0;i<t.length;i++){var s=t[i];var n=BX.type.isNotEmptyString(s["semantics"])?s["semantics"]:"";if(e===n){return s}}return null},_findAllStepInfoBySemantics:function(e){var t=[];var i=this._stepInfos;for(var s=0;s<i.length;s++){var n=i[s];var r=BX.type.isNotEmptyString(n["semantics"])?n["semantics"]:"";if(e===r){t.push(n)}}return t},_findStepInfoIndex:function(e){var t=this._stepInfos;for(var i=0;i<t.length;i++){if(t[i]["id"]===e){return i}}return-1},_enableStepHints:function(e){for(var t=0;t<this._steps.length;t++){this._steps[t].enableHint(e)}}};BX.CrmProgressControl.items={};BX.CrmProgressControl.create=function(e,t){var i=new BX.CrmProgressControl;i.initialize(e,t);this.items[e]=i;return i};BX.CrmProgressControl._synchronize=function(e){var t=e.getEntityType();var i=e.getEntityId();for(var s in this.items){if(!this.items.hasOwnProperty(s)){continue}var n=this.items[s];if(n===e){continue}if(n.getEntityType()===t&&n.getEntityId()===i){n.setCurrentStepId(e.getCurrentStepId())}}}}if(typeof BX.CrmProgressStep==="undefined"){BX.CrmProgressStep=function(){this._id="";this._settings=null;this._control=null;this._container=null;this._name="";this._hint="";this._isPassed=false;this._isReadOnly=false;this._enableHint=true;this._hintPopup=null;this._hintPopupTimeoutId=null;this.isDisabled=false;this.semantics=null};BX.CrmProgressStep.prototype={initialize(e,t){this._id=e;this._settings=t||BX.CrmParamBag.create(null);this._control=this.getSetting("control");this._container=this._control.getStepContainer(this._id);this._name=this.getSetting("name");this._hint=this.getSetting("hint","");this._isPassed=this.getSetting("isPassed",false);this._isReadOnly=this.getSetting("isReadOnly",false);this.semantics=this.getSetting("semantics","");if(!this._isReadOnly){BX.bind(this._container,"mouseover",BX.delegate(this._onMouseOver,this));BX.bind(this._container,"mouseout",BX.delegate(this._onMouseOut,this));BX.bind(this._container,"click",BX.delegate(this._onClick,this))}},getId:function(){return this._id},getName:function(){return this._name},getSetting:function(e,t){return this._settings.getParam(e,t)},isPassed:function(){return this._isPassed},setPassed:function(e){e=!!e;if(this._isPassed===e){return}this._isPassed=e;if(!this._control.isCustomColorsEnabled()){var t=BX.findParent(this._container,{class:"crm-list-stage-bar-part"});if(e){BX.addClass(t,"crm-list-stage-passed")}else{BX.removeClass(t,"crm-list-stage-passed")}}},isReadOnly:function(){return this._isReadOnly},isHintEnabled:function(){return this._enableHint},enableHint:function(e){e=!!e;if(this._enableHint===e){return}this._enableHint=e;if(!e){this.hideStepHint()}},getSemantics(){return this.semantics},displayStepHint(e){if(!this._enableHint||this._hintPopup){return}const t=this._hint===""?this._name:this._hint;const i=BX.Tag.render`
				<span class="crm-list-bar-popup-text">${BX.util.htmlspecialchars(t)}</span>
			`;if(this.isDisable()){BX.Dom.style(i,"opacity","0.6")}const s=BX.pos(this._container);const n=`step-hint-${this.getId()}`;this._hintPopup=BX.PopupWindowManager.create(n,e,{className:"crm-list-bar-popup-table",content:i,offsetLeft:s.width/2,offsetTop:5,angle:{position:"bottom",offset:0}});this._hintPopup.show()},hideStepHint(){if(!this._hintPopup){return}this._hintPopup.close();this._hintPopup.destroy();this._hintPopup=null},_onClick:function(e){if(!this._isReadOnly){this._control.setCurrentStep(this)}e.stopPropagation()},_onMouseOver(e){if(this._hintPopupTimeoutId!==null){window.clearTimeout(this._hintPopupTimeoutId)}const t=e||window.event;const i=t.target||t.srcElement;this._hintPopupTimeoutId=window.setTimeout((()=>{this._hintPopupTimeoutId=null;this.displayStepHint(i)}),300)},_onMouseOut:function(e){if(this._hintPopupTimeoutId!==null){window.clearTimeout(this._hintPopupTimeoutId)}if(!this._enableHint){return}var t=this;this._hintPopupTimeoutId=window.setTimeout((function(){t._hintPopupTimeoutId=null;t.hideStepHint()}),300)},isDisable(){return this.isDisabled},setDisable(){if(this.isDisabled){return}this.isDisabled=true;const e=this._container.parentElement;BX.Dom.addClass(e,"--disabled")},removeDisable(){if(!this.isDisabled){return}this.isDisabled=false;const e=this._container.parentElement;BX.Dom.removeClass(e,"--disabled")}};BX.CrmProgressStep.create=function(e,t){var i=new BX.CrmProgressStep;i.initialize(e,t);return i}}if(typeof BX.CrmProcessTerminationDialog==="undefined"){BX.CrmProcessTerminationDialog=function(){this._id="";this._settings=null;this._terminationControl=null;this._popup=null;this._wrapper=null;this._openNotifier=null;this._closeNotifier=null;this._result="";this._enableCallback=true};BX.CrmProcessTerminationDialog.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:BX.CrmParamBag.create(null);this._terminationControl=this.getSetting("terminationControl",null);this._openNotifier=BX.CrmNotifier.create(this);this._closeNotifier=BX.CrmNotifier.create(this)},getSetting:function(e,t){return this._settings.getParam(e,t)},getId:function(){return this._id},getResult:function(){return this._result},open:function(){if(!this._popup){this._popup=new BX.PopupWindow(this._id,this.getSetting("anchor"),{closeByEsc:true,autoHide:false,offsetLeft:-50,closeIcon:true,className:"crm-list-end-deal",content:this._prepareContent(),events:{onPopupShow:BX.delegate(this._onPopupShow,this),onPopupClose:BX.delegate(this._onPopupClose,this)}})}this._popup.show()},addOpenListener:function(e){this._openNotifier.addListener(e)},removeOpenListener:function(e){this._openNotifier.removeListener(e)},close:function(e){this._enableCallback=!!e;if(this._popup){this._popup.close()}},addCloseListener:function(e){this._closeNotifier.addListener(e)},removeCloseListener:function(e){this._closeNotifier.removeListener(e)},_onPopupShow:function(){this._openNotifier.notify()},_onPopupClose:function(){if(this._popup){this._popup.destroy();this._popup=null}this._closeNotifier.notify();this._executeCallback()},_prepareContent(){this._wrapper=BX.Tag.render`<div></div>`;const e=BX.Tag.render`
				<table class='crm-list-end-deal-block' cellspacing="0" cellpadding="0" border="0"></table>
			`;BX.Dom.append(e,this._wrapper);let t=e.insertRow(-1).insertCell(-1);t.className="crm-list-end-deal-text";t.innerHTML=this.getSetting("title","");t=e.insertRow(-1).insertCell(-1);t.className="crm-list-end-deal-buttons-block";["success","failure"].forEach((e=>{const i=this.getButtonBySemantics(e);if(i!==null){BX.Dom.append(i,t)}}));return this._wrapper},getButtonBySemantics(e){if(!["success","failure"].includes(e)){return null}const t=this.getControls();const i=`${e}Button`;if(BX.type.isElementNode(t[i])){return t[i]}const s=this.getSetting(e,null);if(!s){return null}const n=this.getTitleByInfo(s);const r=e==="success"?"accept":"decline";const a=BX.Tag.render`
				<a class="webform-small-button webform-small-button-${r}">
					<span class="webform-small-button-left"></span>
					<span class="webform-small-button-text">${BX.Text.encode(n)}</span>
					<span class="webform-small-button-right"></span>
				</a>
			`;this.prepareButtonByCallback(a,s);BX.CrmSubscriber.subscribe(`${this.getId()}_${s.id}`,a,"click",this._onButtonClick.bind(this),BX.CrmParamBag.create({id:s.id,preventDefault:true}));return a},getTitleByInfo(e){const t=e.semantics;const i=`${t}Title`;let s=this.getSetting(i,"");if(s===""){s=BX.type.isNotEmptyString(e.name)?e.name:t}return s},getControls(){let e=this._terminationControl?.prepareDialogControls(this);if(!BX.type.isPlainObject(e)){e={}}return e},_onButtonClick:function(e,t){this._result=e.getSetting("id","");this._executeCallback()},_executeCallback:function(){if(this._enableCallback){var e=this.getSetting("callback");if(BX.type.isFunction(e)){e(this,{result:this._result})}}},prepareButtonByCallback(e,t){const i=this.getSetting("buttonPrepareCallback",null);if(BX.type.isFunction(i)){i(e,t)}}};BX.CrmProcessTerminationDialog.create=function(e,t){var i=new BX.CrmProcessTerminationDialog;i.initialize(e,t);return i}}if(typeof BX.CrmProcessFailureDialog==="undefined"){BX.CrmProcessFailureDialog=function(){this._id="";this._settings=null;this._popup=null;this._wrapper=null;this._callback=null;this._enableCallback=true;this._value="";this._bid="";this._successInfo=null;this._failureInfo=null;this._apologyInfos=null;this._failureTitle="";this._selectorTitle="";this._radioButtonBlock=null;this._popupMenuId="";this._popupMenu=null};BX.CrmProcessFailureDialog.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:BX.CrmParamBag.create(null);this._callback=this.getSetting("callback",null);this._successInfo=this.getSetting("success",null);if(!this._successInfo){throw"BX.CrmProcessFailureDialog: 'success' setting is not found!"}this._failureInfo=this.getSetting("failure",null);if(!this._failureInfo){throw"BX.CrmProcessFailureDialog: 'failure' setting is not found!"}this._apologyInfos=this.getSetting("apologies",null);if(!BX.type.isArray(this._apologyInfos)){this._apologyInfos=[]}var i=this.getSetting("initValue","");if(i===""){i=this._failureInfo["id"]}this._value=i;this._failureTitle=this.getSetting("failureTitle","");this._selectorTitle=this.getSetting("selectorTitle","");this._popupMenuId=this._id+"_MENU"},getSetting:function(e,t){return this._settings.getParam(e,t)},getEntityType:function(){return this.getSetting("entityType")},getEntityId:function(){return this.getSetting("entityId")},getId:function(){return this._id},getValue:function(){return this._value},setValue:function(e,t){if(this._value===e){return}this._value=e;if(typeof t==="undefined"){t=true}else{t=!!t}if(t){var i=BX.findChildren(this._wrapper,{className:"crm-list-fail-deal-button"},true);for(var s=0;s<i.length;s++){var n=i[s];n.checked=n.value===e}}BX.onCustomEvent(this,"CrmProcessFailureDialogValueChanged",[this,e])},selectFirstAvailableOption(){const e=this._wrapper.querySelectorAll(".crm-list-fail-deal-button");for(const t of e){if(t.disabled||BX.Dom.hasClass(t.parentElement,"--disabled")){continue}t.checked=true;return}},getSuccessValue:function(){return this._successInfo["id"]},getBid:function(){return this._bid},getWrapper:function(){return this._wrapper},open:function(){if(this._popup){this._popup.show();return}this._popup=new BX.PopupWindow(this._id,this.getSetting("anchor"),{closeByEsc:true,autoHide:true,offsetLeft:-50,closeIcon:true,className:"crm-list-fail-deal",titleBar:{content:this._prepareTitle()},content:this._prepareContent(),events:{onPopupClose:BX.delegate(this._onPopupClose,this)},buttons:[new BX.PopupWindowButton({text:BX.message["JS_CORE_WINDOW_SAVE"],className:"popup-window-button-accept",events:{click:BX.delegate(this._onAcceptButtonClick,this)}}),new BX.PopupWindowButtonLink({text:BX.message["JS_CORE_WINDOW_CANCEL"],className:"popup-window-button-link-cancel",events:{click:BX.delegate(this._onCancelButtonClick,this)}})]});this._popup.show()},close:function(e){this._enableCallback=!!e;if(this._popup){this._popup.close()}},getFailureTitle:function(){var e=this._failureTitle;if(e==""){e=BX.type.isNotEmptyString(this._failureInfo["name"])?this._failureInfo["name"]:this._failureInfo["id"]}return e},getSuccessTitle:function(){return BX.type.isNotEmptyString(this._successInfo["name"])?this._successInfo["name"]:this._successInfo["id"]},_onPopupClose:function(){this._closePopupMenu();if(this._popup){this._popup.destroy();this._popup=null}this._executeCallback()},_closePopupMenu:function(){if(this._popupMenu){BX.PopupMenu.Data[this._popupMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._popupMenuId];this._popupMenu=null}},_prepareTitle:function(){var e=BX.create("DIV",{attrs:{class:"crm-list-fail-deal-selector-block"}});e.appendChild(BX.create("SPAN",{text:this._selectorTitle+": "}));var t=this._value===this._successInfo["id"];this._selector=BX.create("DIV",{attrs:{className:"crm-list-end-deal-option crm-list-end-deal-option-"+(t?"success":"fail")},events:{click:BX.delegate(this._onSelectorClick,this)},text:t?this.getSuccessTitle():this.getFailureTitle()});e.appendChild(this._selector);return e},_prepareContent(){const e=this._wrapper=BX.Tag.render`<div class="crm-list-fail-deal-block"></div>`;const t=this.getSetting("title","");if(t!==""){const i=BX.Tag.render`<div class="crm-list-end-deal-text">${BX.utils.htmlspecialchars(t)}</div>`;BX.Dom.append(i,e)}this._radioButtonBlock=BX.Tag.render`<div class="crm-list-end-deal-block-section"></div>`;const i=[this._failureInfo];const s=this._apologyInfos;if(BX.type.isArray(s)&&s.length>0){s.forEach((e=>{i.push(e)}))}i.forEach((e=>{const t=BX.Tag.render`<div class="crm-list-end-deal-button-wrapper"></div>`;const i=e.id;const s=`${this._id}_${i}`;const n=BX.Tag.render`
					<input 
						id="${s}"
						name="${this._id}"
						class="crm-list-fail-deal-button"
						type="radio"
						value="${i}" 
					>
				`;n.checked=this._value===i;BX.CrmSubscriber.subscribe(`${this._id}_${i}`,n,"change",this._onRadioButtonClick.bind(this),BX.CrmParamBag.create({id:i}));BX.Dom.append(n,t);const r=BX.type.isNotEmptyString(e.name)?e.name:i;const a=BX.Tag.render`
					<label for="${s}" class="crm-list-fail-deal-button-label">
						${BX.Text.encode(r)}
					</label>
				`;BX.Dom.append(a,t);BX.Dom.append(t,this._radioButtonBlock)}));if(this._value===this._successInfo.id||s.length===0){BX.Dom.style(this._radioButtonBlock,"display","none")}BX.Dom.append(this._radioButtonBlock,e);BX.onCustomEvent(this,"CrmProcessFailureDialogContentCreated",[this,e]);return e},_onRadioButtonClick:function(e,t){this.setValue(e.getSetting("id",""),false)},_onAcceptButtonClick:function(e){this._bid="accept";this._executeCallback()},_onCancelButtonClick:function(e){this._bid="cancel";this._value="";this._executeCallback()},_onSelectorClick:function(){if(this._popupMenu){this._closePopupMenu();return}if(typeof BX.PopupMenu.Data[this._popupMenuId]!=="undefined"){BX.PopupMenu.Data[this._popupMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._popupMenuId]}BX.PopupMenu.show(this._popupMenuId,this._selector,[{text:this.getFailureTitle(),onclick:function(){this.selectFirstAvailableOption();if(this._radioButtonBlock.style.display==="none"&&this._apologyInfos.length>0){this._radioButtonBlock.style.display=""}this._selector.innerHTML=BX.util.htmlspecialchars(this.getFailureTitle());BX.removeClass(this._selector,"crm-list-end-deal-option-success");BX.addClass(this._selector,"crm-list-end-deal-option-fail");window.setTimeout(function(){this._closePopupMenu()}.bind(this),0)}.bind(this)},{text:this.getSuccessTitle(),onclick:function(){this.setValue(this._successInfo["id"],true);if(this._radioButtonBlock.style.display!=="none"){this._radioButtonBlock.style.display="none"}this._selector.innerHTML=BX.util.htmlspecialchars(this.getSuccessTitle());BX.removeClass(this._selector,"crm-list-end-deal-option-fail");BX.addClass(this._selector,"crm-list-end-deal-option-success");window.setTimeout(function(){this._closePopupMenu()}.bind(this),0)}.bind(this)}],{autoHide:true,offsetTop:0,offsetLeft:-30});this._popupMenu=BX.PopupMenu.Data[this._popupMenuId]},_executeCallback:function(){if(this._enableCallback){var e=this._callback;if(BX.type.isFunction(e)){e(this,{bid:this._bid,result:this._value})}}}};BX.CrmProcessFailureDialog.create=function(e,t){var i=new BX.CrmProcessFailureDialog;i.initialize(e,t);return i}}
//# sourceMappingURL=progress_control.map.js